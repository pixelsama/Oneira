# å‚è€ƒå›¾ä¸Šä¼ ä¸ @ æåŠåŠŸèƒ½å®ç°è®¡åˆ’

**åˆ›å»ºæ—¥æœŸ**: 2026-01-17  
**çŠ¶æ€**: å¾…å®æ–½  
**ä¼˜å…ˆçº§**: é«˜

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°å®Œæ•´çš„å‚è€ƒå›¾ä¸Šä¼ ã€ç®¡ç†å’Œå¼•ç”¨ç³»ç»Ÿï¼Œæ”¯æŒï¼š

1. ä½¿ç”¨ Tauri åŸç”Ÿå¯¹è¯æ¡†é€‰æ‹©å›¾ç‰‡æ–‡ä»¶
2. æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡
3. å›¾ç‰‡ç¼©ç•¥å›¾é¢„è§ˆä¸è‡ªå®šä¹‰å‘½å
4. åœ¨ Prompt è¾“å…¥æ¡†ä¸­é€šè¿‡ `@` ç¬¦å·å¼•ç”¨å›¾ç‰‡
5. åç«¯é›†æˆè±†åŒ…å›¾ç”Ÿå›¾ API

---

## ğŸ¯ ç›®æ ‡ç”¨æˆ·ä½“éªŒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prompt è¾“å…¥æ¡†                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ å°† [ğŸ“· è§’è‰²è®¾è®¡å›¾] çš„æœè£…æ¢ä¸º [ğŸ“· æ—¶è£…å‚è€ƒ] çš„é£æ ¼@          â”‚â”‚
â”‚  â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚                                              â”‚ è§’è‰²è®¾è®¡å›¾ â”‚ â”‚â”‚
â”‚  â”‚                                              â”‚ æ—¶è£…å‚è€ƒ   â”‚ â”‚â”‚
â”‚  â”‚                                              â”‚ èƒŒæ™¯ç´ æ   â”‚ â”‚â”‚
â”‚  â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â”‚  å·²ä¸Šä¼ å›¾ç‰‡ï¼š                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  ğŸ–¼ï¸      â”‚ â”‚  ğŸ–¼ï¸      â”‚ â”‚  ğŸ–¼ï¸      â”‚ â”‚    +     â”‚           â”‚
â”‚  â”‚ è§’è‰²è®¾è®¡å›¾â”‚ â”‚ æ—¶è£…å‚è€ƒ â”‚ â”‚ èƒŒæ™¯ç´ æ â”‚ â”‚  ä¸Šä¼     â”‚           â”‚
â”‚  â”‚   âœï¸ âŒ  â”‚ â”‚   âœï¸ âŒ  â”‚ â”‚   âœï¸ âŒ  â”‚ â”‚          â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ features/
â”‚   â””â”€â”€ creative-studio/
â”‚       â””â”€â”€ components/
â”‚           â”œâ”€â”€ ImageUploader.tsx        # é‡æ„ï¼šå›¾ç‰‡ä¸Šä¼ åŒºåŸŸ
â”‚           â”œâ”€â”€ UploadedImageCard.tsx    # æ–°å¢ï¼šå•å¼ å›¾ç‰‡å¡ç‰‡ï¼ˆç¼©ç•¥å›¾ã€åç§°ã€ç¼–è¾‘ã€åˆ é™¤ï¼‰
â”‚           â”œâ”€â”€ PromptInput.tsx          # é‡æ„ï¼šæ”¯æŒ @ æåŠ
â”‚           â””â”€â”€ MentionMenu.tsx          # æ–°å¢ï¼š@ æåŠä¸‹æ‹‰èœå•
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ referenceImageStore.ts           # æ–°å¢ï¼šå‚è€ƒå›¾çŠ¶æ€ç®¡ç†
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useMentionInput.ts               # æ–°å¢ï¼š@ æåŠè¾“å…¥é€»è¾‘
â””â”€â”€ types/
    â””â”€â”€ referenceImage.ts                # æ–°å¢ï¼šç±»å‹å®šä¹‰

src-tauri/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ commands/
â”‚       â””â”€â”€ generate.rs                  # ä¿®æ”¹ï¼šæ”¯æŒå›¾ç”Ÿå›¾å‚æ•°
â””â”€â”€ Cargo.toml                           # å¯èƒ½éœ€è¦æ·»åŠ ä¾èµ–
```

---

## ğŸ“¦ Phase 1: åŸºç¡€è®¾æ–½

### 1.1 å®‰è£… Tauri Dialog æ’ä»¶

```bash
# å‰ç«¯
pnpm add @tauri-apps/plugin-dialog

# åç«¯ (Cargo.toml)
tauri-plugin-dialog = "2"
```

**æ³¨å†Œæ’ä»¶** (`src-tauri/src/lib.rs`):

```rust
.plugin(tauri_plugin_dialog::init())
```

**æƒé™é…ç½®** (`capabilities/default.json`):

```json
"dialog:default"
```

### 1.2 ç±»å‹å®šä¹‰

**`src/types/referenceImage.ts`**:

```typescript
export interface ReferenceImage {
  id: string; // å”¯ä¸€æ ‡è¯† (uuid)
  originalPath: string; // æœ¬åœ°æ–‡ä»¶è·¯å¾„
  displayName: string; // ç”¨æˆ·å¯ç¼–è¾‘çš„æ˜¾ç¤ºåç§°
  originalFileName: string; // åŸå§‹æ–‡ä»¶åï¼ˆä¸å¯å˜ï¼‰
  thumbnailDataUrl?: string; // Base64 ç¼©ç•¥å›¾ï¼ˆç”¨äºå¿«é€Ÿé¢„è§ˆï¼‰
  addedAt: number; // æ·»åŠ æ—¶é—´æˆ³
}
```

### 1.3 çŠ¶æ€ç®¡ç†

**`src/stores/referenceImageStore.ts`**:

```typescript
import { create } from 'zustand';
import type { ReferenceImage } from '../types/referenceImage';

interface ReferenceImageState {
  images: ReferenceImage[];

  // Actions
  addImage: (path: string, fileName: string) => Promise<void>;
  removeImage: (id: string) => void;
  updateDisplayName: (id: string, newName: string) => void;
  clearAll: () => void;

  // Utils
  getImageById: (id: string) => ReferenceImage | undefined;
  getImageByName: (name: string) => ReferenceImage | undefined;
}
```

---

## ğŸ“¦ Phase 2: å›¾ç‰‡ä¸Šä¼ ç»„ä»¶

### 2.1 ImageUploader é‡æ„

**åŠŸèƒ½éœ€æ±‚**:

- ç‚¹å‡»æ‰“å¼€ Tauri åŸç”Ÿæ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
- æ”¯æŒæ‹–æ‹½ä¸Šä¼ ï¼ˆä½¿ç”¨ HTML5 Drag & Drop APIï¼‰
- æ”¯æŒå¤šé€‰æ–‡ä»¶
- æ–‡ä»¶ç±»å‹è¿‡æ»¤ï¼š`jpg, jpeg, png, webp, gif`
- ä¸Šä¼ åç«‹å³æ˜¾ç¤ºç¼©ç•¥å›¾

**å®ç°è¦ç‚¹**:

```typescript
import { open } from '@tauri-apps/plugin-dialog';
import { readFile } from '@tauri-apps/plugin-fs';

const handleSelectFiles = async () => {
  const selected = await open({
    multiple: true,
    filters: [
      {
        name: 'Images',
        extensions: ['jpg', 'jpeg', 'png', 'webp', 'gif'],
      },
    ],
  });

  if (selected) {
    const paths = Array.isArray(selected) ? selected : [selected];
    for (const path of paths) {
      await addImage(path);
    }
  }
};
```

**æ‹–æ‹½ä¸Šä¼ **:

```typescript
const handleDrop = async (e: DragEvent) => {
  e.preventDefault();
  const files = e.dataTransfer?.files;
  // æ³¨æ„ï¼šWeb æ‹–æ‹½è·å–çš„æ˜¯ File å¯¹è±¡ï¼Œéœ€è¦é€šè¿‡ Tauri è½¬æ¢ä¸ºè·¯å¾„
  // æˆ–è€…ç›´æ¥è¯»å–ä¸º base64
};
```

### 2.2 UploadedImageCard ç»„ä»¶

**UI ç»“æ„**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   [ç¼©ç•¥å›¾ 80x80] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“· æ˜¾ç¤ºåç§°      â”‚  â† å¯ç‚¹å‡»ç¼–è¾‘
â”‚     âœï¸     âŒ   â”‚  â† ç¼–è¾‘/åˆ é™¤æŒ‰é’®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Props**:

```typescript
interface UploadedImageCardProps {
  image: ReferenceImage;
  onRename: (id: string, newName: string) => void;
  onRemove: (id: string) => void;
}
```

---

## ğŸ“¦ Phase 3: @ æåŠç³»ç»Ÿ

### 3.1 PromptInput é‡æ„

**æ ¸å¿ƒéœ€æ±‚**:

1. æ£€æµ‹ `@` å­—ç¬¦è¾“å…¥
2. æ˜¾ç¤º/éšè— MentionMenu
3. å¤„ç†é”®ç›˜äº‹ä»¶ï¼ˆâ†‘â†“ å¯¼èˆªã€Enter é€‰æ‹©ã€Tab å¿«é€Ÿé€‰æ‹©ã€Esc å–æ¶ˆï¼‰
4. æ’å…¥å¼•ç”¨æ ‡ç­¾ï¼ˆè§†è§‰ä¸Šä¸ºåœ†è§’çŸ©å½¢æ ‡ç­¾ï¼‰
5. æ”¯æŒæ–‡æœ¬ä¸æ ‡ç­¾æ··åˆç¼–è¾‘

**å®ç°æ–¹æ¡ˆ**:
ä½¿ç”¨ `contenteditable` div æˆ–è‡ªå®šä¹‰ HTML ç»“æ„æ¥æ”¯æŒå†…åµŒæ ‡ç­¾ã€‚

**çŠ¶æ€ç»“æ„**:

```typescript
interface MentionState {
  isOpen: boolean; // èœå•æ˜¯å¦æ‰“å¼€
  searchQuery: string; // @ åçš„æœç´¢å…³é”®è¯
  selectedIndex: number; // å½“å‰é€‰ä¸­é¡¹ç´¢å¼•
  cursorPosition: number; // å…‰æ ‡ä½ç½®
}
```

### 3.2 MentionMenu ç»„ä»¶

**UI**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“· è§’è‰²è®¾è®¡å›¾    â”‚  â† é«˜äº®é€‰ä¸­
â”‚ ğŸ“· æ—¶è£…å‚è€ƒ      â”‚
â”‚ ğŸ“· èƒŒæ™¯ç´ æ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŠŸèƒ½**:

- æ ¹æ®è¾“å…¥è¿‡æ»¤åŒ¹é…çš„å›¾ç‰‡åç§°
- é”®ç›˜å¯¼èˆªï¼ˆâ†‘â†“ ç§»åŠ¨é€‰æ‹©ï¼‰
- Enter ç¡®è®¤é€‰æ‹©
- Tab å¿«é€Ÿé€‰æ‹©ç¬¬ä¸€é¡¹
- ç‚¹å‡»é€‰æ‹©
- Esc å…³é—­èœå•

**Props**:

```typescript
interface MentionMenuProps {
  images: ReferenceImage[];
  searchQuery: string;
  selectedIndex: number;
  onSelect: (image: ReferenceImage) => void;
  position: { top: number; left: number };
}
```

### 3.3 å¼•ç”¨æ ‡ç­¾æ¸²æŸ“

**è§†è§‰æ•ˆæœ**:

```
[ğŸ“· è§’è‰²è®¾è®¡å›¾]
```

- èƒŒæ™¯ï¼š`bg-purple-900/50`
- è¾¹æ¡†ï¼š`border border-purple-600`
- åœ†è§’ï¼š`rounded-md`
- å†…è¾¹è·ï¼š`px-2 py-0.5`
- å­—ä½“ï¼š`text-sm text-purple-300`

**æ•°æ®ç»“æ„**:

```typescript
interface PromptContent {
  type: 'text' | 'image-reference';
  value: string; // æ–‡æœ¬å†…å®¹æˆ–å›¾ç‰‡ ID
}

// ç¤ºä¾‹
const content: PromptContent[] = [
  { type: 'text', value: 'å°† ' },
  { type: 'image-reference', value: 'uuid-of-image-1' },
  { type: 'text', value: ' çš„æœè£…æ¢ä¸º ' },
  { type: 'image-reference', value: 'uuid-of-image-2' },
  { type: 'text', value: ' çš„é£æ ¼' },
];
```

### 3.4 Prompt åºåˆ—åŒ–

å‘é€ç»™åç«¯æ—¶ï¼Œéœ€è¦å°†å†…å®¹è½¬æ¢ä¸ºçº¯æ–‡æœ¬ï¼š

```typescript
const serializePrompt = (content: PromptContent[], images: ReferenceImage[]): string => {
  return content
    .map((item) => {
      if (item.type === 'text') {
        return item.value;
      } else {
        const image = images.find((img) => img.id === item.value);
        return image ? `å›¾ç‰‡æ–‡ä»¶[${image.displayName}]` : '';
      }
    })
    .join('');
};

// è¾“å‡ºç¤ºä¾‹: "å°† å›¾ç‰‡æ–‡ä»¶[è§’è‰²è®¾è®¡å›¾] çš„æœè£…æ¢ä¸º å›¾ç‰‡æ–‡ä»¶[æ—¶è£…å‚è€ƒ] çš„é£æ ¼"
```

---

## ğŸ“¦ Phase 4: åç«¯é›†æˆï¼ˆBase64 æ–¹å¼ï¼‰

### 4.1 è±†åŒ…å®˜æ–¹é™åˆ¶

æ ¹æ®è±†åŒ…å®˜æ–¹æ–‡æ¡£ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨ **Base64 ç¼–ç æ–¹å¼**ï¼ˆå› ä¸ºæ–‡ä»¶è·¯å¾„ä¸Šä¼ ä»…æ”¯æŒ Python/Go SDKï¼‰ï¼š

| é¡¹ç›®          | é™åˆ¶                                    |
| ------------- | --------------------------------------- |
| å•å¼ å›¾ç‰‡å¤§å°  | < 10 MB                                 |
| è¯·æ±‚ä½“æ€»å¤§å°  | < 64 MB                                 |
| Data URI æ ¼å¼ | `data:{mime_type};base64,{base64_data}` |

### 4.2 ä¿®æ”¹ GeneratePayload

**`src-tauri/src/models/mod.rs`**:

```rust
#[derive(Debug, Deserialize)]
pub struct GeneratePayload {
    pub prompt: String,
    pub width: u32,
    pub height: u32,
    pub count: u32,
    // æ–°å¢
    pub reference_images: Option<Vec<String>>,  // å›¾ç‰‡è·¯å¾„åˆ—è¡¨
}
```

### 4.3 å®ç°å›¾ç‰‡è½¬ Base64ï¼ˆå®Œæ•´ç‰ˆï¼‰

**æ–°å¢è¾…åŠ©å‡½æ•°** (`src-tauri/src/commands/generate.rs`):

```rust
use std::path::Path;

/// æ ¹æ®æ–‡ä»¶æ‰©å±•åè·å– MIME ç±»å‹
fn get_mime_type(path: &Path) -> Result<&'static str, String> {
    match path.extension().and_then(|s| s.to_str()) {
        Some("jpg") | Some("jpeg") => Ok("image/jpeg"),
        Some("png") => Ok("image/png"),
        Some("webp") => Ok("image/webp"),
        Some("gif") => Ok("image/gif"),
        _ => Err("Unsupported image format. Supported: jpg, png, webp, gif".to_string()),
    }
}

/// å°†æœ¬åœ°å›¾ç‰‡è½¬æ¢ä¸º Base64 Data URI
fn image_to_base64_uri(path: &str) -> Result<String, String> {
    let file_path = Path::new(path);

    // 1. éªŒè¯æ–‡ä»¶å­˜åœ¨
    if !file_path.exists() {
        return Err(format!("Image file not found: {}", path));
    }

    // 2. æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ< 10MBï¼‰
    let metadata = fs::metadata(file_path).map_err(|e| e.to_string())?;
    const MAX_SIZE: u64 = 10 * 1024 * 1024; // 10 MB
    if metadata.len() > MAX_SIZE {
        return Err(format!(
            "Image too large: {} MB (max 10 MB). Path: {}",
            metadata.len() / 1024 / 1024,
            path
        ));
    }

    // 3. è·å– MIME ç±»å‹
    let mime_type = get_mime_type(file_path)?;

    // 4. è¯»å–æ–‡ä»¶å¹¶ç¼–ç 
    let bytes = fs::read(file_path).map_err(|e| e.to_string())?;
    let base64_str = BASE64_STANDARD.encode(&bytes);

    // 5. æ„é€  Data URI
    Ok(format!("data:{};base64,{}", mime_type, base64_str))
}
```

### 4.4 ä¿®æ”¹ generate_doubao å‡½æ•°

**é›†æˆå›¾ç‰‡å¤„ç†é€»è¾‘**:

```rust
async fn generate_doubao(
    store: &tauri_plugin_store::Store<tauri::Wry>,
    client: &Client,
    output_path: &Path,
    payload: GeneratePayload,
) -> Result<Vec<String>, String> {
    // ... existing code (API token, model, size)

    let mut body = json!({
        "model": model,
        "prompt": payload.prompt,
        "sequential_image_generation": "disabled",
        "response_format": "url",
        "size": size_str,
        "stream": false,
        "watermark": false
    });

    // ğŸ”¥ æ–°å¢ï¼šå¤„ç†å‚è€ƒå›¾ç‰‡
    if let Some(ref_images) = &payload.reference_images {
        if !ref_images.is_empty() {
            // è½¬æ¢ä¸º Base64 Data URIs
            let image_uris: Vec<String> = ref_images
                .iter()
                .map(|path| image_to_base64_uri(path))
                .collect::<Result<Vec<_>, _>>()?;

            // æ ¹æ®æ•°é‡å†³å®šæ ¼å¼
            if image_uris.len() == 1 {
                // å•å¼ å›¾ç‰‡ï¼šç›´æ¥ä¼ å­—ç¬¦ä¸²
                body["image"] = json!(image_uris[0]);
            } else {
                // å¤šå¼ å›¾ç‰‡ï¼šä¼ æ•°ç»„
                body["image"] = json!(image_uris);
            }
        }
    }

    // ... rest of code (HTTP request)
}
```

### 4.5 è±†åŒ… API å›¾ç”Ÿå›¾å‚æ•°è§„èŒƒ

| åœºæ™¯                  | `image` æ ¼å¼                           | `sequential_image_generation` |
| --------------------- | -------------------------------------- | ----------------------------- |
| å•å¼ å‚è€ƒå›¾ â†’ å•å¼ è¾“å‡º | `"image": "data:image/png;base64,..."` | `"disabled"`                  |
| å•å¼ å‚è€ƒå›¾ â†’ å¤šå¼ è¾“å‡º | `"image": "data:image/png;base64,..."` | `"auto"`                      |
| å¤šå¼ å‚è€ƒå›¾ â†’ å•å¼ è¾“å‡º | `"image": ["data:...", "data:..."]`    | `"disabled"`                  |
| å¤šå¼ å‚è€ƒå›¾ â†’ å¤šå¼ è¾“å‡º | `"image": ["data:...", "data:..."]`    | `"auto"`                      |

---

## ğŸ“¦ Phase 5: å‰ç«¯ Store é›†æˆ

### 5.1 ä¿®æ”¹ generationStore

**æ–°å¢å­—æ®µ**:

```typescript
interface GenerationState {
  // ... existing fields

  // æ–°å¢
  promptContent: PromptContent[]; // ç»“æ„åŒ– prompt å†…å®¹

  // Actions
  setPromptContent: (content: PromptContent[]) => void;
  insertImageReference: (imageId: string) => void;
  getSerializedPrompt: () => string;
  getReferencedImagePaths: () => string[];
}
```

### 5.2 è°ƒç”¨ç”Ÿæˆ API æ—¶

```typescript
const handleGenerate = async () => {
  const prompt = getSerializedPrompt();
  const referenceImages = getReferencedImagePaths();

  await invoke('generate_image', {
    payload: {
      prompt,
      width: settings.width,
      height: settings.height,
      count: settings.count,
      reference_images: referenceImages.length > 0 ? referenceImages : null,
    },
  });
};
```

---

## âœ… å®æ–½æ£€æŸ¥æ¸…å•

### Phase 1: åŸºç¡€è®¾æ–½ (é¢„è®¡ 30 åˆ†é’Ÿ)

- [ ] å®‰è£… `@tauri-apps/plugin-dialog`
- [ ] æ›´æ–° `Cargo.toml` æ·»åŠ  `tauri-plugin-dialog`
- [ ] æ³¨å†Œæ’ä»¶åˆ° Tauri Builder
- [ ] æ›´æ–° `capabilities/default.json`
- [ ] åˆ›å»º `types/referenceImage.ts`
- [ ] åˆ›å»º `stores/referenceImageStore.ts`

### Phase 2: å›¾ç‰‡ä¸Šä¼ ç»„ä»¶ (é¢„è®¡ 1 å°æ—¶)

- [ ] é‡æ„ `ImageUploader.tsx` - æ”¯æŒç‚¹å‡»é€‰æ‹©
- [ ] æ·»åŠ æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
- [ ] åˆ›å»º `UploadedImageCard.tsx`
- [ ] å®ç°ç¼©ç•¥å›¾ç”Ÿæˆ
- [ ] å®ç°åç§°ç¼–è¾‘åŠŸèƒ½
- [ ] å®ç°åˆ é™¤åŠŸèƒ½

### Phase 3: @ æåŠç³»ç»Ÿ (é¢„è®¡ 2 å°æ—¶)

- [ ] åˆ›å»º `MentionMenu.tsx`
- [ ] é‡æ„ `PromptInput.tsx` æ”¯æŒ contenteditable
- [ ] å®ç° `@` æ£€æµ‹é€»è¾‘
- [ ] å®ç°é”®ç›˜å¯¼èˆªï¼ˆâ†‘â†“ Enter Tab Escï¼‰
- [ ] å®ç°æœç´¢è¿‡æ»¤
- [ ] å®ç°å¼•ç”¨æ ‡ç­¾æ’å…¥ä¸æ¸²æŸ“
- [ ] å®ç° prompt åºåˆ—åŒ–

### Phase 4: åç«¯é›†æˆ (é¢„è®¡ 1 å°æ—¶)

- [ ] ä¿®æ”¹ `GeneratePayload` ç»“æ„ä½“
- [ ] ä¿®æ”¹ `generate_doubao` æ”¯æŒå›¾ç‰‡å‚æ•°
- [ ] ä¿®æ”¹ `generate_openai`ï¼ˆå¦‚é€‚ç”¨ï¼‰
- [ ] æµ‹è¯•å›¾ç”Ÿå›¾åŠŸèƒ½

### Phase 5: é›†æˆæµ‹è¯• (é¢„è®¡ 30 åˆ†é’Ÿ)

- [ ] ç«¯åˆ°ç«¯æµ‹è¯•ï¼šä¸Šä¼  â†’ å‘½å â†’ å¼•ç”¨ â†’ ç”Ÿæˆ
- [ ] è¾¹ç•Œæƒ…å†µæµ‹è¯•
- [ ] é”™è¯¯å¤„ç†éªŒè¯

---

## ğŸš¨ é£é™©ä¸æ³¨æ„äº‹é¡¹

1. **Base64 å¤§å°é™åˆ¶** (è±†åŒ…å®˜æ–¹é™åˆ¶):
   - å•å¼ å›¾ç‰‡å¿…é¡» < 10 MB
   - è¯·æ±‚ä½“æ€»å¤§å° < 64 MB
   - **å»ºè®®**ï¼šå‰ç«¯å®ç°å›¾ç‰‡å‹ç¼©/ç¼©æ”¾ï¼ˆå¦‚ä½¿ç”¨ Canvas API å‹ç¼©åˆ° 2MB ä»¥å†…ï¼‰
2. **æ‹–æ‹½å…¼å®¹æ€§**: Tauri æ‹–æ‹½å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œéœ€æµ‹è¯•

3. **contenteditable å¤æ‚æ€§**: å…‰æ ‡ç®¡ç†ã€é€‰åŒºæ“ä½œå¯èƒ½æœ‰å…¼å®¹æ€§é—®é¢˜

4. **API é”™è¯¯å¤„ç†**:
   - å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒ
   - å›¾ç‰‡è¿‡å¤§
   - Base64 ç¼–ç å¤±è´¥
   - ç½‘ç»œè¯·æ±‚è¶…æ—¶

5. **å‰ç«¯å›¾ç‰‡å‹ç¼©æ–¹æ¡ˆ** (æ¨è)ï¼š
   ```typescript
   // ä½¿ç”¨ Canvas API å‹ç¼©å›¾ç‰‡
   const compressImage = async (file: File, maxSizeMB: number = 2): Promise<Blob> => {
     const img = await createImageBitmap(file);
     const canvas = document.createElement('canvas');
     // ... resize logic
     return canvas.toBlob(blob, 'image/jpeg', 0.8);
   };
   ```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Tauri Dialog Plugin](https://tauri.app/plugin/dialog/)
- [è±†åŒ…å›¾ç”Ÿå›¾ API](docs/doubao.md)
- [React contenteditable æœ€ä½³å®è·µ](https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/contentEditable)
